<!DOCTYPE html>
<html lang="eu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self';
                   script-src 'self' https://cdn.jsdelivr.net https://unpkg.com https://rthjrzmkozvungmiiikt.supabase.co 'unsafe-inline' 'unsafe-eval';
                   style-src 'self' https://cdnjs.cloudflare.com https://unpkg.com 'unsafe-inline';
                   font-src 'self' https://cdnjs.cloudflare.com data:;
                   img-src 'self' data: https:;
                   connect-src 'self' https://rthjrzmkozvungmiiikt.supabase.co wss://rthjrzmkozvungmiiikt.supabase.co https://*.supabase.co wss://*.supabase.co;
                   frame-src 'self' https://rthjrzmkozvungmiiikt.supabase.co https://*.supabase.co;
                   media-src 'self';
                   object-src 'none';
                   base-uri 'self';
                   form-action 'self' https://rthjrzmkozvungmiiikt.supabase.co;">
    <!-- Diagnostiko script-a CSP meta tag-aren ONDOREN -->
    <script>
    // üî• DIAGNOSTIKO SCRIPT - Zer gertatzen ari den jakiteko
    console.log('üîç === DIAGNOSTIKO SCRIPT HASIERA ===');
    
    // 1. CSP KONFIGURAZIOA EGIAZTATU
    const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
    if (cspMeta) {
        console.log('‚úÖ CSP Meta tag aurkitua');
        console.log('üìã CSP Politika:', cspMeta.getAttribute('content'));
    } else {
        console.warn('‚ö†Ô∏è CSP Meta tag EZ dago');
    }
    
    // 2. FONT-SRC EGIAZTATU
    const cspContent = cspMeta ? cspMeta.getAttribute('content') : '';
    if (cspContent.includes('font-src')) {
        const fontSrcMatch = cspContent.match(/font-src([^;]+)/);
        if (fontSrcMatch) {
            console.log('üî§ Font-src direktoriboa:', fontSrcMatch[1]);
            console.log('‚ùì Gstatic baimenduta?', fontSrcMatch[1].includes('gstatic') ? '‚úÖ BAI' : '‚ùå EZ');
        }
    }
    
    // 3. ERROREAK HARTZEKO LISTENERRAK
    window.addEventListener('error', function(e) {
        console.error('üî• GLOBAL ERROR:', {
            message: e.message,
            filename: e.filename,
            lineno: e.lineno,
            colno: e.colno,
            error: e.error
        });
        
        // Font errorea bada
        if (e.message.includes('font') || e.message.includes('gstatic')) {
            console.warn('üéØ FONT ERROREA DETEXATUTA - Tailwind edo Font Awesome-tik etor daiteke');
        }
    });
    
    // 4. CSP VIOLAZIOAK HARTAZEKO
    document.addEventListener('securitypolicyviolation', function(e) {
        console.warn('üö® CSP VIOLAZIOA:', {
            blockedURI: e.blockedURI,
            violatedDirective: e.violatedDirective,
            originalPolicy: e.originalPolicy
        });
        
        // Font violazioa bada
        if (e.violatedDirective.includes('font')) {
            console.log('üî§ FONT VIOLAZIOA - Arrazoiak:');
            console.log('   - Font Awesome (cdnjs) erabiltzen ari al gara?');
            console.log('   - Material Icons (gstatic) beharrezkoa al da?');
            console.log('   - Tailwind-ek font kanpokoak erabiltzen ditu?');
        }
    });
    
    // 5. STYLESHEET-EN KARGA EGIAZTATU
    function checkStylesheets() {
        console.log('üé® STYLESHEET-EN EGIAZTAPENA:');
        
        // Tailwind
        const tailwindLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
            .filter(link => link.href.includes('tailwind'));
        
        console.log('   Tailwind esteka(k):', tailwindLinks.length);
        tailwindLinks.forEach((link, i) => {
            console.log(`   ${i+1}. ${link.href}`);
            console.log(`      Ondo kargatuta? ${link.sheet ? '‚úÖ BAI' : '‚ùå EZ'}`);
        });
        
        // Font Awesome
        const faLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
            .filter(link => link.href.includes('font-awesome') || link.href.includes('all.min.css'));
        
        console.log('   Font Awesome esteka(k):', faLinks.length);
    }
    
    // 6. FONT KARGATZEKO ERROREAK DETEKTATU
    const originalFontFace = window.FontFace;
    window.FontFace = function(family, source, descriptors) {
        console.log('üî§ FONT-A SORTZEN:', {
            family: family,
            source: typeof source === 'string' ? source.substring(0, 100) : source,
            external: typeof source === 'string' && source.includes('http')
        });
        
        const font = new originalFontFace(family, source, descriptors);
        
        font.load().then(function(loadedFont) {
            console.log(`‚úÖ FONT KARGATUTA: ${family}`);
        }).catch(function(error) {
            console.error(`‚ùå FONT KARGATZEKO ERROREA (${family}):`, error);
        });
        
        return font;
    };
    
    // 7. ORRIAREN KARGA EGIAZTATU
    window.addEventListener('load', function() {
        console.log('üìÑ === ORRIA OSO KARGATUTA ===');
        
        checkStylesheets();
        
        // Tailwind klase batzuk egiaztatu
        const testDiv = document.createElement('div');
        testDiv.className = 'hidden';
        document.body.appendChild(testDiv);
        const hasHiddenClass = window.getComputedStyle(testDiv).display === 'none';
        console.log('   Tailwind "hidden" klasea funtzionatzen?', hasHiddenClass ? '‚úÖ BAI' : '‚ùå EZ');
        testDiv.remove();
        
        // Font Awesome ikonoak
        const faTest = document.createElement('i');
        faTest.className = 'fas fa-test';
        document.body.appendChild(faTest);
        const faLoaded = window.getComputedStyle(faTest, '::before').content !== 'none';
        console.log('   Font Awesome ikonoak funtzionatzen?', faLoaded ? '‚úÖ BAI' : '‚ùå EZ');
        faTest.remove();
    });
    
    // 8. DOM KARGATZEAN EGIAZTATU
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üå≥ === DOM KARGATUTA ===');
        console.log('   Body elementua:', document.body ? '‚úÖ BAI' : '‚ùå EZ');
        console.log('   Head elementua:', document.head ? '‚úÖ BAI' : '‚ùå EZ');
        
        // Tailwind CSS-aren presentzia
        setTimeout(checkStylesheets, 100);
    });
    
    // 9. AZKEN EGIAZTAPENAK
    setTimeout(function() {
        console.log('‚è±Ô∏è === 3s ONDOREN EGIAZTAPENA ===');
        
        // Tailwind erabiliz CSS propietate batzuk
        const bodyStyles = window.getComputedStyle(document.body);
        console.log('   Body background-color:', bodyStyles.backgroundColor);
        console.log('   Body font-family:', bodyStyles.fontFamily);
        
        // Font errore kopurua
        const errors = performance.getEntriesByType('resource')
            .filter(entry => entry.initiatorType === 'css' && entry.name.includes('font'));
        console.log('   Font resource erroreak:', errors.length);
        
    }, 3000);
    
    console.log('üîç === DIAGNOSTIKO SCRIPT AMAITUTA (listenerrak aktibo) ===');
    </script>
    <title>Curriculum Kudeatzailea (Supabase)</title>
    <!-- Changed Tailwind from CDN to local -->
    <link href="css/tailwind.min.css" rel="stylesheet">
    <!-- Original: <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet"> -->
    <script>
    // üî• MOVER ESTO AL INICIO - Definiciones cr√≠ticas
    function checkSupabaseStatus() {
        console.log('‚úÖ Supabase egoera: Konektatuta');
        return true;
    }
    
    // üî• Funci√≥n placeholder para evitar errores
    window.updateUI = async function() {
        console.log('‚ö†Ô∏è updateUI llamado pero a√∫n no definida completamente');
    };
    </script>
    <script src="config.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .editable-list-textarea {
            min-height: 100px;
            white-space: pre-wrap;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
    <script>
    // üî• BLOQUEADOR DEFINITIVO DE TAC/ADS
    (function() {
        console.log('üõ°Ô∏è Activando bloqueador de scripts maliciosos...');
        
        // 1. Eliminar scripts TAC inmediatamente
        const removeTACScripts = () => {
            document.querySelectorAll('script').forEach(script => {
                const src = script.src || '';
                if (src.includes('content-v2') || src.includes('tac') || src.includes('ad')) {
                    console.log('üóëÔ∏è Eliminando script malicioso:', src);
                    script.remove();
                }
            });
        };
        
        // 2. Bloquear creaci√≥n din√°mica de scripts en el head
        const originalAppendChild = document.head.appendChild;
        document.head.appendChild = function(element) {
            if (element.tagName === 'SCRIPT' && element.src) {
                if (element.src.includes('content-v2') || element.src.includes('tac') || element.src.includes('/ads/')) {
                    console.log('üö´ Previniendo creaci√≥n de script malicioso en head:', element.src);
                    // Devuelve el elemento pero no lo a√±ade
                    return element;
                }
            }
            return originalAppendChild.call(this, element);
        };
        
        // 3. Bloquear fetch/XHR
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (typeof url === 'string' && 
                (url.includes('content-v2') || url.includes('tac.') || url.includes('/ads/'))) {
                console.log('üö´ Bloqueando fetch malicioso:', url);
                return Promise.reject(new Error('Recurso bloqueado por seguridad'));
            }
            return originalFetch.apply(this, args);
        };
        
        // 4. Ejecutar inmediatamente y peri√≥dicamente
        removeTACScripts();
        setInterval(removeTACScripts, 2000);
        
        // 5. Observar DOM para nuevos scripts (MutationObserver)
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.tagName === 'SCRIPT' && node.src) {
                        if (node.src.includes('content-v2') || node.src.includes('tac') || node.src.includes('ad')) {
                            console.log('üëÄ Detectado script malicioso:', node.src);
                            node.remove();
                        }
                    }
                });
            });
        });
        
        observer.observe(document.documentElement, {
            childList: true,
            subtree: true
        });
        
        console.log('‚úÖ Bloqueador activado');
    })();
    </script>
    <script>
        // üî• DESREGISTRAR SERVICE WORKERS AL CARGAR
        (function() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    console.log('Service workers encontrados:', registrations.length);
                    registrations.forEach(function(registration) {
                        console.log('Desregistrando:', registration.scope);
                        registration.unregister();
                    });
                });
                
                if (window.caches) {
                    caches.keys().then(function(cacheNames) {
                        cacheNames.forEach(function(cacheName) {
                            caches.delete(cacheName);
                        });
                    });
                }
            }
        })();
    </script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    
    <!-- üî• Script adicional para bloquear handlers problem√°ticos -->
    <script>
        // Bloquear fetch handlers problem√°ticos
        if (window.addEventListener) {
            window.addEventListener('fetch', function(e) {
                const url = e.request.url;
                if (url.includes('service-worker') || url.includes('content-v2')) {
                    console.log('Fetch bloqueado:', url);
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
            }, true);
        }
    </script>

    <!-- Karga Adierazlea -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="flex flex-col items-center text-indigo-700">
            <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
            <p id="loadingText">Datuak kargatzen eta autentifikatzen...</p>
        </div>
    </div>

    <!-- Goiburua -->
    <header class="bg-indigo-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold mb-4 md:mb-0">
                <i class="fas fa-graduation-cap mr-2"></i>Curriculum Kudeatzailea
            </h1>
            
            <div class="flex flex-wrap gap-2 md:gap-4 items-center justify-end">
                <!-- Auth botoiak -->
                <div id="authButtons" class="flex gap-2">
                    <button id="signInBtn" onclick="signInWithGoogle()" 
                        class="bg-white text-indigo-700 px-3 py-1.5 rounded flex items-center text-sm btn">
                        <i class="fab fa-google mr-2"></i>Hasi Saioa
                    </button>
                    <button id="signOutBtn" onclick="signOut()" 
                        class="bg-red-500 text-white px-3 py-1.5 rounded flex items-center text-sm btn hidden">
                        <i class="fas fa-sign-out-alt mr-2"></i>Irten
                    </button>
                </div>
                
                <!-- Erabiltzaile informazioa -->
                <div id="userInfo" class="hidden items-center gap-2">
                    <span id="userEmail" class="text-xs bg-indigo-500 px-2 py-1 rounded truncate max-w-[150px]"></span>
                    <span id="userRole" class="text-xs bg-green-500 px-2 py-1 rounded">Irakaslea</span>
                </div>
                
                <!-- App botoiak (rolaren arabera) -->
                <div id="appButtons" class="hidden flex-wrap gap-2">
                    <!-- Botoi guztientzat -->
                    <button id="saveBtn" class="bg-green-500 hover:bg-green-600 px-3 py-1.5 rounded flex items-center text-sm btn">
                        <i class="fas fa-save mr-2"></i> Gorde
                    </button>
                    
                    <!-- SUPABASE BOTOIAK (guztientzat) -->
                    <button onclick="viewSupabaseData()" class="bg-indigo-600 hover:bg-indigo-800 px-3 py-1.5 rounded flex items-center text-sm btn">
                        <i class="fas fa-database mr-2"></i> Datuak Ikusi
                    </button>

                    <!-- üî• HISTORIA BOTOIA -->
                    <button onclick="viewEditHistory()" class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1.5 rounded flex items-center text-sm btn">
                        <i class="fas fa-history mr-2"></i> Editore Historia
                    </button>
                    
                    <!-- üî• GEHITU HEMEN - MATRIZAK BOTOIA -->
                    <a href="matrices.html" class="bg-purple-500 hover:bg-purple-600 px-3 py-1.5 rounded flex items-center text-sm btn">
                        <i class="fas fa-th mr-2"></i> Matrizak
                    </a>
                    
                    <!-- üõë ADMIN BOTOIAK (soilik administratzaileentzat) -->
                    <button id="downloadBackupBtn" class="bg-blue-500 hover:bg-blue-600 px-3 py-1.5 rounded flex items-center text-sm btn hidden">
                        <i class="fas fa-download mr-2"></i> Deskargatu JSON
                    </button>
                    
                    <button id="uploadJsonBtn" class="bg-purple-500 hover:bg-purple-600 px-3 py-1.5 rounded flex items-center text-sm btn hidden">
                        <i class="fas fa-file-upload mr-2"></i> Kargatu JSON
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Eduki Nagusia -->
    <main class="container mx-auto p-4 flex-grow flex flex-col md:flex-row gap-6">
        
        <!-- Ezkerreko Zutabea: Nabigazioa -->
        <aside class="w-full md:w-1/3 bg-white p-6 rounded-lg shadow-md h-fit">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Irakasgaiak Aukeratu</h2>
            
            <div id="noDataMessage" class="text-center text-gray-500 py-8 hidden">
                <i class="fas fa-lock text-4xl mb-3"></i>
                <p class="mb-2">Curriculum datuak kargatzeko, mesedez <strong>hasi saioa Google-rekin</strong>.</p>
                <button onclick="signInWithGoogle()" class="bg-indigo-600 text-white px-4 py-2 rounded mt-3 btn">
                    <i class="fab fa-google mr-2"></i>Hasi Saioa Google-rekin
                </button>
            </div>

            <div id="navigationPanel" class="hidden space-y-4">

                <!-- Gradua Hautatu -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gradua</label>
                    <select id="degreeSelect" class="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none btn">
                        <option value="">-- Aukeratu Gradua --</option>
                    </select>
                </div>

                <!-- Maila Hautatu -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Atalak</label>
                    <div class="flex gap-2 flex-wrap" id="sectionButtons">
                        <!-- Botones ser√°n inyectados aqu√≠ -->
                    </div>
                </div>

                <!-- Irakasgaien Zerrenda -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Irakasgaiak</label>
                    <ul id="subjectList" class="border border-gray-200 rounded divide-y divide-gray-100 max-h-96 overflow-y-auto">
                        <li class="p-3 text-gray-500 text-sm italic">Lehenengo Gradua eta Maila aukeratu...</li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Eskuineko Zutabea: Editorea -->
        <section class="w-full md:w-2/3 bg-white p-6 rounded-lg shadow-md min-h-[500px]">
            <div id="welcomeEditor" class="h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-edit text-5xl mb-4"></i>
                <p class="text-lg text-center">Aukeratu irakasgai bat ezkerreko menuan edukiak editatzeko.</p>
            </div>

            <div id="editorPanel" class="hidden fade-in">
                <!-- Irakasgaiaren Goiburua eta Oinarrizko Datuak -->
                <div class="border-b pb-4 mb-6">
                    <span class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full mb-2" id="subjectType">Mota</span>
                    <h2 class="text-2xl font-bold text-gray-800" id="subjectTitle">Irakasgaiaren Izena</h2>
                    <p class="text-gray-600 mt-1" id="subjectCredits">Kredituak: -</p>
                </div>
                
                <!-- Datu Ofizialen Editorea -->
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-6">
                    <h3 class="font-bold text-gray-700 mb-3"><i class="fas fa-info-circle text-indigo-600 mr-2"></i>Datu Ofizialak Editatu</h3>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <!-- Arloa/Eremua -->
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Arloa / Eremua</label>
                            <input type="text" id="subjectArea" class="w-full border p-2 rounded focus:outline-none focus:border-indigo-500">
                        </div>
                        <!-- Irakasgaiaren Izena (editagarria) -->
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Irakasgaiaren Izena</label>
                            <input type="text" id="subjectNameEdit" class="w-full border p-2 rounded focus:outline-none focus:border-indigo-500">
                        </div>
                    </div>

                    <!-- Ikaskuntza Emaitza Ofizialak (lerro bakoitza elementu bat) -->
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Ikaskuntza Emaitza Ofizialak (lerro bakoitza emaitza bat da)</label>
                        <textarea id="subjectRAs" rows="5" class="editable-list-textarea w-full border p-2 rounded focus:outline-none focus:border-indigo-500"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Lerro berri bat sartu behar duzu emaitza bakoitzeko.</p>
                    </div>
                </div>

                <!-- Unitateak Gehitu Formularioa -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                    <h3 class="font-bold text-gray-700 mb-3"><i class="fas fa-plus-circle text-indigo-600 mr-2"></i>Unitate Didaktiko Berria Sortu</h3>
                    <div class="grid gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Unitatearen Izena / Zenbakia</label>
                            <input type="text" id="unitName" placeholder="Adib: 1. Unitatea - Sarrera" class="w-full border p-2 rounded focus:outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Edukiak / Azalpena</label>
                            <textarea id="unitContent" rows="3" placeholder="Unitate honetan landuko diren edukiak..." class="w-full border p-2 rounded focus:outline-none focus:border-indigo-500"></textarea>
                        </div>
                        <button id="addUnitBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition btn">
                            Gehitu Unitatea
                        </button>
                    </div>
                </div>

                <!-- Dauden Unitateen Zerrenda -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-4 text-lg border-b pb-2">Unitate Didaktikoak eta Edukiak</h3>
                    <div id="unitsContainer" class="space-y-4">
                        <!-- Units will be injected here -->
                    </div>
                    <div id="noUnitsMessage" class="text-gray-500 italic text-center py-4 hidden">
                        Ez dago unitaterik sortuta irakasgai honetarako.
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Oina -->
    <footer class="bg-gray-200 text-center p-4 text-gray-600 text-sm mt-auto">
        &copy; 2024 Curriculum Kudeaketa Sistema
    </footer>

    <!-- Feedback Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition-transform duration-300 z-[99999]">
        Mezua hemen
    </div>

    <!-- JSON fitxategia kargatzeko input ezkutua -->
    <input type="file" id="jsonFileInput" accept=".json" class="hidden">

    <!-- Supabase SDK eta JavaScript Logika -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase konfigurazioa - config.js fitxategitik kargatuko da
        const SUPABASE_URL = window.SUPABASE_URL;
        const SUPABASE_KEY = window.SUPABASE_KEY;
    
        // Supabase hasieratu
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // Despu√©s de: const supabase = window.supabase.createClient(...);

        // Detectar si hay sesi√≥n en la URL (despu√©s de redirecci√≥n de Google)
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        if (hashParams.has('access_token') || hashParams.has('error')) {
            console.log('üîê Procesando redirecci√≥n de Google...');
            // Limpiar URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        // Reemplaza o actualiza tu onAuthStateChange

        // üî• GEHITU HAU hasieran
let authStateHandled = false;

// Ondoren, onAuthStateChange hobetu
supabase.auth.onAuthStateChange(async (event, session) => {
    // üî• Saiatu begiztak ekiditeko
    if (authStateHandled && event === 'INITIAL_SESSION') return;
    
    console.log('üîê Auth aldaketa:', event, session?.user?.email);
    
    // Lehenengo logout detektatu
    if (handleLogoutFromUrl()) {
        authStateHandled = true;
        return;
    }
    
    // Gertaera bakoitzeko ekintza espezifikoa
    switch (event) {
        case 'SIGNED_IN':
            console.log('‚úÖ Saioa hasita:', session.user.email);
            // UI eguneratu baina ez kargatu daturik oraindik
            await updateUI();
            // Datuak kargatu 1 segundoren ondoren
            setTimeout(() => {
                loadCurriculumData();
            }, 1000);
            break;
            
        case 'SIGNED_OUT':
            console.log('üö™ Saioa itxita');
            resetUIForLoggedOut();
            break;
            
        case 'INITIAL_SESSION':
            if (session) {
                console.log('üîÑ Saio existentea detektatuta');
                // UI eguneratu bakarrik
                await updateUI();
                // Datuak kargatu
                setTimeout(() => {
                    loadCurriculumData();
                }, 500);
            } else {
                console.log('üîì Ez dago saio aktiborik');
                resetUIForLoggedOut();
            }
            break;
            
        case 'TOKEN_REFRESHED':
            console.log('‚ôªÔ∏è Tokena berritu da');
            // Ez egin ezer
            break;
    }
    
    authStateHandled = true;
});

        // Global variables to store state
        window.curriculumData = null; 
        window.selectedDegree = null;
        window.selectedYear = null;
        window.selectedSubjectIndex = null;

        // ADMIN EMAILAK
        const ADMIN_EMAILS = ['josuayerbe@idarte.eus'];
        const ALLOWED_DOMAINS = ['idarte.eus'];

    // üî•üî•üî• GEHITU HEMEN - kodea üî•üî•üî•
        async function checkAuthProviders() {
            try {
                const { data, error } = await supabase.auth.getUser();
                console.log('Auth egoera:', data);
                
                // Egiaztatu provider-ak
                const { data: settings } = await supabase.auth.getSettings();
                console.log('Auth settings:', settings);
                
            } catch (error) {
                console.error('Errorea auth settings egiaztatzean:', error);
            }
        }
    
        // üî•üî•üî• GEHITU HEMEN - service worker kodea üî•üî•üî•
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    
        // üî•üî•üî• GEHITU HEMEN - fetch handler üî•üî•üî•
        window.addEventListener('fetch', event => {
            event.preventDefault();
            return false;
        });

        // üî• HOBETSUA - Datuak mantendu baina ikuspena kontrolatu
        function hideCurriculumData() {
            // UI ezkutatu baina datuak mantendu
            document.getElementById('navigationPanel').classList.add('hidden');
            document.getElementById('editorPanel').classList.add('hidden');
            document.getElementById('welcomeEditor').classList.remove('hidden');
            document.getElementById('noDataMessage').classList.remove('hidden');
            
            // üî• DATUAK EZ GARBIATU - cache-an mantendu
            // window.curriculumData = null;  // ‚ùå EZ EGIN HAU
            // window.selectedDegree = null;   // ‚ùå EZ EGIN HAU
            
            // Soilik reset selektoreak
            window.selectedDegree = null;
            window.selectedYear = null; 
            window.selectedSubjectIndex = null;
            
            // UI elementuak reset
            document.getElementById('degreeSelect').innerHTML = '<option value="">-- Aukeratu Gradua --</option>';
            document.getElementById('sectionButtons').innerHTML = '';
            document.getElementById('subjectList').innerHTML = '<li class="p-3 text-gray-500 text-sm italic">Saioa hasi behar duzu...</li>';
        }
               
        function isAdmin(user) {
            return user && ADMIN_EMAILS.includes(user.email);
        }
        
        function isValidEmail(email) {
            if (!email) return false;
            const domain = email.split('@')[1];
            return ALLOWED_DOMAINS.includes(domain);
        }

        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            return user;
        }
        
        // AUTH FUNtzioak
        // HTML barruan dagoen kodea eguneratu
        // 6. AUTH FUNtzioak
       window.signInWithGoogle = async function() {
        await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: location.href }
        });
        
        // üî• ESTA ES LA CLAVE - Forzar recarga despu√©s de 3 segundos
        setTimeout(() => location.reload(), 3000);
    };
        
        window.signOut = async function() {
            try {
                // 1Ô∏è‚É£ Confirmar con el usuario
                if (!confirm('Ziur zaude saioa itxi nahi duzula?\n\nHurrengoan berriro Google-rekin hasi beharko duzu saioa.')) {
                    return; // Utzi erabiltzaileak utzi nahi ez badu
                }
                
                console.log('üö™ Saioa ixteko prozesua hasita...');
                
                // 2Ô∏è‚É£ Mostrar karga adierazlea
                document.getElementById('loadingOverlay').classList.remove('hidden');
                document.getElementById('loadingText').textContent = 'Saioa ixteko...';
                
                // 3Ô∏è‚É£ Cerrar sesi√≥n en Supabase (con timeout)
                const signOutPromise = supabase.auth.signOut();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout saioa ixteko')), 5000)
                );
                
                const { error } = await Promise.race([signOutPromise, timeoutPromise]);
                if (error) throw error;
                
                console.log('‚úÖ Supabase saioa itxita');
                
                // 4Ô∏è‚É£ Limpiar SOLO los datos de nuestra app (no todo el localStorage)
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.includes('curriculum') || key.includes('matrix') || key.includes('supabase')) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    console.log(`üóëÔ∏è Kengatu: ${key}`);
                });
                
                // 5Ô∏è‚É£ Limpiar variables globales
                window.curriculumData = null;
                window.selectedDegree = null;
                window.selectedYear = null;
                window.selectedSubjectIndex = null;
                
                // 6Ô∏è‚É£ Redirigir a la misma p√°gina con par√°metros anti-cache
                const cleanUrl = window.location.origin + window.location.pathname;
                const timestamp = new Date().getTime();
                const redirectUrl = `${cleanUrl}?logout=true&_=${timestamp}`;
                
                console.log(`üîÑ Berbideratzen: ${redirectUrl}`);
                
                // 7Ô∏è‚É£ Redirigir inmediatamente
                window.location.href = redirectUrl;
                
            } catch (error) {
                console.error('‚ùå Errorea irtetean:', error);
                
                // Erakutsi errorea
                window.showToast('‚ùå Errorea irtetzean. Saiatu berriro.', 'error');
                
                // Saiatu berriz kargatzen
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    window.location.reload();
                }, 2000);
            }
        };

        // üî• GEHITU HAU - Detectatu logout URL-an
        function handleLogoutFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const hasLogoutParam = urlParams.has('logout');
            const hasTimestamp = urlParams.has('_');
            
            if (hasLogoutParam) {
                console.log('üîç Logout parametroa detektatuta URL-an');
                
                // 1Ô∏è‚É£ Garbitu URL-a (ez erakutsi logout parametroa)
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // 2Ô∏è‚É£ Resetear UI completamente
                resetUIForLoggedOut();
                
                // 3Ô∏è‚É£ Erakutsi mezua
                window.showToast('‚úÖ Saioa ondo itxita. Berriro hasi saioa ahal izateko.', 'success');
                
                // 4Ô∏è‚É£ Egin Supabase sign-out berriro (segurtasunerako)
                setTimeout(() => {
                    supabase.auth.signOut().catch(() => {});
                }, 100);
                
                return true;
            }
            
            return false;
        }
        
        // üî• GEHITU HAU - Reset UI funtzioa
        function resetUIForLoggedOut() {
            console.log('üîÑ UI reset saioa itxita...');
            
            // üî• BILATU ELEMENTU GUZTIAK ALDI BATEAN
            const elements = {
                signInBtn: document.getElementById('signInBtn'),
                signOutBtn: document.getElementById('signOutBtn'),
                userInfo: document.getElementById('userInfo'),
                appButtons: document.getElementById('appButtons'),
                noDataMessage: document.getElementById('noDataMessage'),
                navigationPanel: document.getElementById('navigationPanel'),
                welcomeEditor: document.getElementById('welcomeEditor'),
                editorPanel: document.getElementById('editorPanel'),
                degreeSelect: document.getElementById('degreeSelect'),
                sectionButtons: document.getElementById('sectionButtons'),
                subjectList: document.getElementById('subjectList'),
                loadingOverlay: document.getElementById('loadingOverlay')
            };
            
            // üî• A. SAIOA ITXITA - ELEMENTUAK EGUNERATU
            // 1. Erakutsi/hizkutu klaseak
            const showElements = ['signInBtn', 'noDataMessage', 'welcomeEditor'];
            const hideElements = ['signOutBtn', 'userInfo', 'appButtons', 'navigationPanel', 'editorPanel', 'loadingOverlay'];
            
            showElements.forEach(id => {
                if (elements[id]) elements[id].classList.remove('hidden');
            });
            
            hideElements.forEach(id => {
                if (elements[id]) elements[id].classList.add('hidden');
            });
            
            // üî• B. SELECTOREAK GARBIATU
            // 2. Dropdown eta listak reset
            if (elements.degreeSelect) {
                elements.degreeSelect.innerHTML = '<option value="">-- Aukeratu Gradua --</option>';
            }
            
            if (elements.sectionButtons) {
                elements.sectionButtons.innerHTML = '';
            }
            
            if (elements.subjectList) {
                elements.subjectList.innerHTML = '<li class="p-3 text-gray-500 text-sm italic">Saioa hasi behar duzu irakasgaiak ikusteko...</li>';
            }
            
            // üî• C. TOAST MEZUA (aukerakoa)
            setTimeout(() => {
                if (typeof window.showToast === 'function') {
                    window.showToast('‚úÖ Saioa ondo itxita. Berriro hasi saioa ahal izateko.', 'success');
                }
            }, 500);
            
            console.log('‚úÖ UI reset saioa itxita');
        }
        
        async function viewEditHistory() {
            const user = await checkAuth();
            if (!user) {
                window.showToast('‚ùå Saioa hasi behar duzu historia ikusteko', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('curriculum_data')
                    .select('last_updated, updated_by, user_role')
                    .order('last_updated', { ascending: false });
                
                if (error) throw error;
                
                console.log('Editore historia:', data);
                
                // Datuak erakutsi alerta batean
                let message = 'üïê Editore Historia:\n\n';
                data.forEach((item, index) => {
                    const data = new Date(item.last_updated).toLocaleString('eu-EU');
                    message += `${index + 1}. ${data}\n`;
                    message += `   Erabiltzailea: ${item.updated_by}\n`;
                    message += `   Rola: ${item.user_role}\n\n`;
                });
                
                alert(message);
                
            } catch (error) {
                console.error('Errorea historia kargatzean:', error);
                window.showToast('‚ùå Errorea historia kargatzean', 'error');
            }
        }        
        // UI EGUNERAKETA
        let isInitialLoadComplete = false;  // üî• GEHITU FLAG BAT

        async function updateUI() {
            // üî• LEHENENGO: EGIAZTATU JADA KARGATZEN ARI GAREN
            if (window.isUpdatingUI) return;
            window.isUpdatingUI = true;
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                console.log('üîÑ updateUI exekutatzen:', user ? user.email : 'Erabiltzailerik gabe');
                
                if (user && isValidEmail(user.email)) {
                    // ‚úÖ 1. UI Erakutsi (baina ez kargatu daturik)
                    document.getElementById('signInBtn').classList.add('hidden');
                    document.getElementById('signOutBtn').classList.remove('hidden');
                    document.getElementById('userInfo').classList.remove('hidden');
                    document.getElementById('appButtons').classList.remove('hidden');
                    
                    // ‚úÖ 2. Erabiltzaile informazioa
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userRole').textContent = isAdmin(user) ? 'Admin' : 'Irakaslea';
                    
                    // ‚úÖ 3. ADMIN botoiak
                    if (isAdmin(user)) {
                        document.getElementById('downloadBackupBtn').classList.remove('hidden');
                        document.getElementById('uploadJsonBtn').classList.remove('hidden');
                    }
                    
                    // ‚úÖ 4. EZ KARGATU DATUAK HEMEN - Bakarrik UI eguneratu
                    // Datuak loadCurriculumData() funtzioan kargatuko dira bakarrik
                    
                } else {
                    // ‚úÖ 5. Saioa itxita - UI garbia
                    resetUIForLoggedOut();
                }
                
            } catch (error) {
                console.error('‚ùå Errorea updateUI-n:', error);
            } finally {
                window.isUpdatingUI = false;
            }
        }
        
        // DATUAK KARGATU
        async function loadCurriculumData() {
            // üî• GEHITU: Egiaztatu jada kargatzen ari garela
            if (window.isLoadingData) return;
            window.isLoadingData = true;
            
            try {
                console.log('üì• Datuak kargatzen (soilik saioa badago)...');
                
                const { data: { user } } = await supabase.auth.getUser();
                
                // ‚úÖ EGIAZTAPEN TRIPLA:
                // 1. Erabiltzailea existitzen den
                // 2. Email balioduna den
                // 3. Daturik ez dagoeneko kargatuta egon
                if (!user || !isValidEmail(user.email) || window.curriculumData) {
                    console.log('‚è≠Ô∏è Datuak ez dira kargatuko:', {
                        hasUser: !!user,
                        validEmail: user ? isValidEmail(user.email) : false,
                        dataAlreadyLoaded: !!window.curriculumData
                    });
                    return;
                }
                
                // Datuak kargatu
                const { data, error } = await supabase
                    .from('curriculum_data')
                    .select('*')
                    .order('last_updated', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0 && data[0].curriculum) {
                    window.curriculumData = data[0].curriculum;
                    console.log('‚úÖ Datuak kargatuak Supabase-tik');
                    window.showToast('‚úÖ Datuak kargatuak', 'success');
                    
                    // UI eguneratu
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    document.getElementById('noDataMessage').classList.add('hidden');
                    document.getElementById('navigationPanel').classList.remove('hidden');
                    
                    // UI hasieratu
                    if (window.initializeUI) {
                        window.initializeUI();
                    }
                } else {
                    // Supabase hutsik ‚Üí JSON lokala
                    console.log('üìÑ Supabase hutsik, JSON lokala kargatzen...');
                    await loadLocalJsonData(true);
                }
                
            } catch (error) {
                console.error('‚ùå Errorea datuak kargatzean:', error);
                document.getElementById('loadingOverlay').classList.add('hidden');
                
                // Errorea bada, erakutsi saioa hasteko mezua
                if (!window.curriculumData) {
                    document.getElementById('noDataMessage').classList.remove('hidden');
                    document.getElementById('navigationPanel').classList.add('hidden');
                }
                
                window.showToast('‚ùå Errorea datuak kargatzean', 'error');
            } finally {
                window.isLoadingData = false;
            }
        }
   
        // Datuak gorde (erabiltzaile infoarekin)
       async function saveCurriculumData() {
            // üî• EGIAZTATU SAIORIK DAGOEN
            const user = await checkAuth();
            if (!user) {
                window.showToast('‚ùå Saioa hasi behar duzu gordetzeko', 'error');
                return;
            }
            
            // üî• EGIAZTATU DATUAK DAUDELA
            if (!window.curriculumData) {
                window.showToast('‚ùå Ez dago daturik gordetzeko', 'error');
                return;
            }
            
            try {
                // üî• Karga adierazlea erakutsi
                document.getElementById('loadingOverlay').classList.remove('hidden');
                
                const { error } = await supabase
                    .from('curriculum_data')
                    .upsert({
                        curriculum: window.curriculumData,
                        last_updated: new Date().toISOString(),
                        updated_by: user.email,
                        user_role: isAdmin(user) ? 'admin' : 'teacher'
                    });
                
                if (error) throw error;
                
                window.showToast('‚úÖ Datuak gorde dira!', 'success');
                
            } catch (error) {
                console.error('Errorea gordetzean:', error);
                window.showToast('‚ùå Errorea gordetzean: ' + error.message, 'error');
            } finally {
                // üî• Karga adierazlea ezkutatu (erroreren bat gertatu ala ez)
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }
        
        // Denbora errealeko eguneraketak
        // Funci√≥n mejorada para setupRealtimeUpdates
        function setupRealtimeUpdates() {
            try {
                console.log('üîå Conectando WebSocket a Supabase...');
                
                const channel = supabase
                    .channel('curriculum-changes')
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'curriculum_data' 
                        },
                        (payload) => {
                            console.log('üîÑ Cambio en tiempo real:', payload);
                            if (payload.new && payload.new.curriculum) {
                                window.curriculumData = payload.new.curriculum;
                                if (window.initializeUI) {
                                    window.initializeUI();
                                }
                                window.showToast?.('üîÑ Datos actualizados (compa√±eros)', 'normal');
                            }
                        }
                    )
                    .subscribe((status) => {
                        console.log('üì° Estado WebSocket:', status);
                        if (status === 'SUBSCRIBED') {
                            console.log('‚úÖ WebSocket conectado exitosamente');
                        } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                            console.warn('‚ö†Ô∏è WebSocket cerrado, reintentando en 5s...');
                            setTimeout(setupRealtimeUpdates, 5000);
                        }
                    });
                    
                return channel;
            } catch (error) {
                console.error('‚ùå Error conectando WebSocket:', error);
                // Reintentar despu√©s de 10 segundos
                setTimeout(setupRealtimeUpdates, 10000);
                return null;
            }
        }

        // Gehitu funtzio hau zure kodean
        function handleAuthRedirect() {
            // Egiaztatu token-a URL-an badago
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            
            if (accessToken) {
                console.log('‚úÖ Token-a aurkitu da URL-an - saioa hasita');
                
                // Token-a automatikoki prozesatuko da Supabase-k
                // Eguneratu UI-a
                setTimeout(() => {
                    window.updateUI();
                }, 1000);
            }
        }
         
        // Supabase-tik datuak berkargatu (behartu)
        async function forceReloadFromSupabase() {
            try {
                document.getElementById('loadingOverlay').classList.remove('hidden');
                
                const { data, error } = await supabase
                    .from('curriculum_data')
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    window.curriculumData = data[0].curriculum;
                    window.initializeUI();
                    window.showToast('‚úÖ Datuak berkargatu dira Supabase-tik', 'success');
                } else {
                    window.showToast('‚ÑπÔ∏è Ez dago daturik Supabase-n', 'normal');
                }
                
            } catch (error) {
                console.error('Errorea Supabase-tik berkargatzean:', error);
                window.showToast('‚ùå Errorea datuak berkargatzean', 'error');
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        // Datuak ikusi Supabase-n (nork egin duen ikusi)
        async function viewSupabaseData() {
            const user = await checkAuth();
            if (!user) return;
            
            try {
                const { data, error } = await supabase
                    .from('curriculum_data')
                    .select('*')
                    .order('last_updated', { ascending: false });
                
                if (error) throw error;
                
                console.log('Supabase Datuak (nork egin duen):', data);
                
                // Datuak erakutsi mezu batean
                let message = `Supabase-n dauden erregistroak: ${data.length}\n\n`;
                data.forEach((item, index) => {
                    message += `${index + 1}. Data: ${new Date(item.last_updated).toLocaleString('eu-EU')}\n`;
                    message += `   Erabiltzailea: ${item.updated_by}\n`;
                    message += `   Rola: ${item.user_role || 'ez dago'}\n\n`;
                });
                
                alert(message);
                
            } catch (error) {
                console.error('Errorea datuak ikustean:', error);
                window.showToast('‚ùå Errorea datuak ikustean', 'error');
            }
        }
        
        // Datuak normalizatzeko funtzioa
        window.normalizeData = function(data) {
            for (const degree in data) {
                for (const year in data[degree]) {
                    if (Array.isArray(data[degree][year])) {
                        data[degree][year].forEach((subject, subjectIndex) => {
                            if (!Array.isArray(subject.unitateak)) {
                                if (typeof subject.unitateak === 'string') {
                                    try {
                                        const parsedUnits = JSON.parse(subject.unitateak);
                                        subject.unitateak = Array.isArray(parsedUnits) ? parsedUnits : [];
                                    } catch (e) {
                                        subject.unitateak = [];
                                    }
                                } else {
                                    subject.unitateak = [];
                                }
                            }
                            
                            subject.unitateak.forEach((unit, unitIndex) => {
                                if (typeof unit.id !== 'string' || isNaN(parseInt(unit.id)) || unit.id.startsWith('fallback-')) {
                                    unit.id = `fallback-${subjectIndex}-${unitIndex}-${Date.now() + Math.floor(Math.random() * 1000)}`;
                                }
                            });

                            if (!Array.isArray(subject.currentOfficialRAs)) {
                                subject.currentOfficialRAs = [];
                            }
                        });
                    }
                }
            }
        };
        
        // --- JSON fitxategia tokiko datuetatik kargatzeko funtzioa ---
        window.loadLocalJsonData = async function(isInitialLoad = false) {
            try {
                // JSON lokala kargatu fetch bidez
                const response = await fetch('curriculum_eguneratua_2025-11-27.json');
                if (!response.ok) {
                    throw new Error('JSON fitxategia ezin izan da kargatu');
                }
                
                const parsedData = await response.json();
                window.curriculumData = parsedData;
                window.normalizeData(window.curriculumData);
                
                // UI eguneratu
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('noDataMessage').classList.add('hidden');
                document.getElementById('navigationPanel').classList.remove('hidden');
                
                window.selectedDegree = null;
                window.selectedYear = null;
                window.selectedSubjectIndex = null;
                window.initializeUI(); 
                window.resetEditor();

                if (isInitialLoad) {
                    window.showToast("Supabase hutsik dago. Tokiko JSON kargatu da.", "normal");
                    // ‚úÖ SUPABASE-N GORDE
                    await window.saveCurriculumData();
                } else {
                    window.showToast("Tokiko JSON datuak kargatu dira.", "success");
                }

            } catch (e) {
                console.error("Tokiko JSON kargatze errorea:", e);
                window.showToast("Errorea tokiko JSON datuak kargatzean.", "error");
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }
        
        // --- JSON Deskarga Funtzioa (Segurtasun Kopia) ---
        // Datuak deskargatu (soilik administratzaileentzat)
        window.downloadJsonData = async function() {
            const user = await checkAuth();
            
            if (!isAdmin(user)) {
                window.showToast('‚ùå Baimenik ez deskargatzeko', 'error');
                return;
            }
            
            if (!window.curriculumData) {
                window.showToast("Ez dago daturik deskargatzeko!", "error");
                return;
            }
            
            try {
                const dataStr = JSON.stringify(window.curriculumData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0, 10);
                a.download = `curriculum_backup_${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                window.showToast("‚úÖ Datuak deskargatu dira (soilik administratzailea)", "success");
            } catch (e) {
                console.error("JSON deskarga errorea:", e);
                window.showToast("Errorea datuak deskargatzean.", "error");
            }
        }
        
        // JSON kargatu (soilik administratzaileentzat)
        async function uploadJsonFile() {
            const user = await checkAuth();
            
            if (!isAdmin(user)) {
                window.showToast('‚ùå Baimenik ez kargatzeko', 'error');
                return;
            }
            
            document.getElementById('jsonFileInput').click();
        }

        // --- UI Rendering eta Ekintza Funtzioak ---
        
        window.initializeUI = function() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('downloadBackupBtn').disabled = false;

            const degreeSelect = document.getElementById('degreeSelect');
            degreeSelect.innerHTML = '<option value="">-- Aukeratu Gradua --</option>';
            
            Object.keys(window.curriculumData).forEach(degree => {
                const option = document.createElement('option');
                option.value = degree;
                option.textContent = degree;
                degreeSelect.appendChild(option);
            });
            
            if (window.selectedDegree) {
                degreeSelect.value = window.selectedDegree;
                window.renderYears();
                if (window.selectedYear) {
                    window.renderSubjects();
                    if (window.selectedSubjectIndex !== null) {
                        window.loadSubjectEditor(window.selectedSubjectIndex);
                    }
                }
            }
            document.getElementById('navigationPanel').classList.remove('hidden');
        }

        // --- UI Funtzio Laguntzaileak (window objektuan gordeta) ---
        window.onDegreeChange = function() {
            const degreeSelect = document.getElementById('degreeSelect');
            window.selectedDegree = degreeSelect.value;
            window.selectedYear = null;
            window.selectedSubjectIndex = null;
            window.renderYears();
            document.getElementById('subjectList').innerHTML = '<li class="p-3 text-gray-500 text-sm italic">Aukeratu maila bat irakasgaiak ikusteko.</li>';
            window.resetEditor();
        }

        window.renderYears = function() {
            const container = document.getElementById('sectionButtons');
            container.innerHTML = '';
            if (!window.selectedDegree || !window.curriculumData[window.selectedDegree]) return;
            const years = Object.keys(window.curriculumData[window.selectedDegree]).sort();
            years.forEach(year => {
                const btn = document.createElement('button');
                btn.textContent = `${year}. Maila`;
                btn.className = `flex-1 py-2 px-3 rounded text-sm font-medium transition border ${window.selectedYear === year ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-indigo-50'}`;
                btn.onclick = () => {
                    window.selectedYear = year;
                    window.renderYears(); 
                    window.renderSubjects();
                    window.resetEditor();
                };
                container.appendChild(btn);
            });
        }

        window.renderSubjects = function() {
            const list = document.getElementById('subjectList');
            list.innerHTML = '';
            if (!window.selectedDegree || !window.selectedYear || !window.curriculumData[window.selectedDegree][window.selectedYear]) {
                 list.innerHTML = '<li class="p-3 text-gray-500 italic">Ez dago irakasgairik maila honetan.</li>';
                 return;
            }
            const subjects = window.curriculumData[window.selectedDegree][window.selectedYear];
            if (subjects.length === 0) {
                list.innerHTML = '<li class="p-3 text-gray-500 italic">Ez dago irakasgairik maila honetan.</li>';
                return;
            }
            subjects.forEach((subject, index) => {
                const li = document.createElement('li');
                li.className = `p-3 cursor-pointer hover:bg-indigo-50 flex justify-between items-center transition ${window.selectedSubjectIndex === index ? 'bg-indigo-50 border-l-4 border-indigo-500' : ''}`;
                li.onclick = () => window.loadSubjectEditor(index);
                const hasUnits = (subject.unitateak && subject.unitateak.length > 0);
                const iconColor = hasUnits ? 'text-green-500' : 'text-gray-300';
                li.innerHTML = `<span class="font-medium text-gray-700">${subject.izena}</span><i class="fas fa-circle ${iconColor} text-xs" title="${hasUnits ? 'Edukiak ditu' : 'Edukirik gabe'}"></i>`;
                list.appendChild(li);
            });
        }
        
        window.getSelectedSubject = function() {
            if (window.selectedDegree && window.selectedYear && window.selectedSubjectIndex !== null) {
                return window.curriculumData[window.selectedDegree][window.selectedYear][window.selectedSubjectIndex];
            }
            return null;
        }

        window.loadSubjectEditor = function(index) {
            window.selectedSubjectIndex = index;
            window.renderSubjects(); 
            const subject = window.getSelectedSubject();
            if (!subject) return;
            document.getElementById('welcomeEditor').classList.add('hidden');
            document.getElementById('editorPanel').classList.remove('hidden');
            document.getElementById('subjectTitle').textContent = subject.izena;
            document.getElementById('subjectType').textContent = subject.mota || "Zehaztugabea";
            document.getElementById('subjectCredits').textContent = `Kredituak: ${subject.kredituak || '-'}`;
            document.getElementById('subjectNameEdit').value = subject.izena || '';
            document.getElementById('subjectArea').value = subject.arloa || '';
            const RAsText = (Array.isArray(subject.currentOfficialRAs) ? subject.currentOfficialRAs.join('\n') : subject.currentOfficialRAs || '');
            document.getElementById('subjectRAs').value = RAsText;
            if (!Array.isArray(subject.unitateak)) { subject.unitateak = []; }
            window.renderUnitsList();
        }

        window.resetEditor = function() {
            document.getElementById('welcomeEditor').classList.remove('hidden');
            document.getElementById('editorPanel').classList.add('hidden');
        }

        window.updateSubjectData = function(key, value) {
            const subject = window.getSelectedSubject();
            if (subject) {
                subject[key] = value;
                window.showToast(`${key} eremua eguneratu da. (Gordetzeko zain)`, "normal");
                window.saveAllDataToFirestore(); 
            }
        }
        
        window.updateSubjectName = function(newName) {
            const subject = window.getSelectedSubject();
            if (subject) {
                subject.izena = newName;
                document.getElementById('subjectTitle').textContent = newName; 
                window.renderSubjects(); 
                window.showToast("Irakasgaiaren izena eguneratu da. (Gordetzeko zain)", "normal");
                window.saveAllDataToFirestore(); 
            }
        }
        
        window.updateSubjectRAs = function(rawText) {
            const subject = window.getSelectedSubject();
            if (subject) {
                const RAsArray = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                subject.currentOfficialRAs = RAsArray;
                window.showToast("Ikaskuntza Emaitzak eguneratu dira. (Gordetzeko zain)", "normal");
                window.saveAllDataToFirestore(); 
            }
        }

        window.addUnit = async function() {
            // üî• EGIAZTATU SAIORIK DAGOEN
            const user = await checkAuth();
            if (!user) {
                window.showToast('‚ùå Saioa hasi behar duzu unitateak gehitzeko', 'error');
                return;
            }
            
            const nameInput = document.getElementById('unitName');
            const contentInput = document.getElementById('unitContent');
            const subject = window.getSelectedSubject();
            
            if (!subject) return;
            if (!nameInput.value.trim() || !contentInput.value.trim()) { 
                window.showToast("Mesedez, bete eremu guztiak.", "error"); 
                return; 
            }
            
            const newUnit = { 
                id: Date.now().toString(), 
                izena: nameInput.value.trim(), 
                edukiak: contentInput.value.trim(), 
                data: new Date().toISOString().slice(0, 10),
                egilea: user.email,  // üÜï GEHITU HAU
                egile_rola: isAdmin(user) ? 'admin' : 'teacher'  // üÜï GEHITU HAU
            };
            
            subject.unitateak.push(newUnit);
            nameInput.value = '';
            contentInput.value = '';
            window.renderUnitsList();
            window.renderSubjects(); 
            window.showToast("Unitatea ondo gehitu da! (Gordetzeko zain)", "success");
            window.saveAllDataToFirestore(); 
        }

        window.deleteUnit = function(unitIndex) {
            const subject = window.getSelectedSubject();
            if (!subject) return;
            subject.unitateak.splice(unitIndex, 1);
            window.renderUnitsList();
            window.renderSubjects();
            window.showToast("Unitatea ezabatu da! (Gordetzeko zain)", "normal");
            window.saveAllDataToFirestore(); 
        }
        
        window.renderUnitsList = function() {
            const container = document.getElementById('unitsContainer');
            const noUnitsMsg = document.getElementById('noUnitsMessage');
            const subject = window.getSelectedSubject();
            if (!subject) return;
        
            const sortedUnits = subject.unitateak.slice().sort((a, b) => {
                const idA = parseInt(a.id);
                const idB = parseInt(b.id);
                return (!isNaN(idA) && !isNaN(idB)) ? idB - idA : 0; 
            });
        
            container.innerHTML = '';
            if (sortedUnits.length === 0) {
                noUnitsMsg.classList.remove('hidden');
            } else {
                noUnitsMsg.classList.add('hidden');
                sortedUnits.forEach((unit) => {
                    const card = document.createElement('div');
                    card.className = "bg-white border border-gray-200 rounded p-4 shadow-sm relative hover:shadow-md transition";
                    const contentFormatted = unit.edukiak ? unit.edukiak.replace(/\n/g, '<br>') : 'Ez dago edukirik.';
                    const originalIndex = subject.unitateak.findIndex(u => u.id === unit.id);
                    
                    // üî• EGUNERATUTA - EGILEAREN INFORMAZIOA GEHITU
                    card.innerHTML = `
                        <button onclick="window.deleteUnit(${originalIndex})" class="absolute top-2 right-2 text-red-400 hover:text-red-600 p-1" title="Ezabatu">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <h4 class="font-bold text-indigo-700 mb-2 text-lg">${unit.izena || 'Izenik gabe'}</h4>
                        <p class="text-xs text-gray-500 mb-2">
                            Gehitze data: ${unit.data || 'Ezezaguna'} 
                            ${unit.egilea ? `| Egilea: ${unit.egilea}` : ''}
                            ${unit.egile_rola ? ` (${unit.egile_rola})` : ''}
                        </p>
                        <div class="text-gray-600 text-sm leading-relaxed bg-gray-50 p-3 rounded">
                            ${contentFormatted}
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
        }
        
        window.showToast = function(message, type = 'normal') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'fixed bottom-5 right-5 px-6 py-3 rounded shadow-lg transform transition-transform duration-300';
            if (type === 'error') { toast.classList.add('bg-red-600', 'text-white'); } 
            else if (type === 'success') { toast.classList.add('bg-green-600', 'text-white'); } 
            else { toast.classList.add('bg-gray-800', 'text-white'); }
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-20');
                setTimeout(() => { toast.classList.add('translate-y-20'); }, 3000);
            });
        }
        
        // Datuak gordetzeko botoia
        window.saveAllDataToFirestore = saveCurriculumData;
        
        // Supabase funtzioak eskuragarri
        window.supabaseIkusiDatuak = viewSupabaseData;
        window.supabaseGehituDatuak = saveCurriculumData;

        // Event listenerrak gehitu
                // Event listenerrak gehitu
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ CURRICULUM APP STARTING...');
            
            // 1Ô∏è‚É£ LEHENENGO: EZABATU updateUI() deialdi guztiak
            // ‚ùå EZ EGIN HAU: checkSupabaseStatus() ‚Üí updateUI() deitzen du
            
            // 2Ô∏è‚É£ Soilik oinarrizkoa konfiguratu
            handleLogoutFromUrl();
            
            // 3Ô∏è‚É£ Supabase konprobatu soilik (ez UI eguneratu)
            console.log('üîç Supabase konprobatzen...');
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user && isValidEmail(user.email)) {
                console.log('‚úÖ Erabiltzailea dago: ' + user.email);
                // Supabase-k eguneratuko du UI-a onAuthStateChange-en
            } else {
                console.log('üîì Saioa itxita');
                // UI oinarrizkoa erakutsi
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('signInBtn').classList.remove('hidden');
                document.getElementById('noDataMessage').classList.remove('hidden');
            }
            
            // 4Ô∏è‚É£ Event listenerrak bakarrik (EZ datuak kargatu)
            setupEventListeners();
            
            // 5Ô∏è‚É£ Denbora errealeko eguneraketak (geroago)
            setTimeout(() => {
                setupRealtimeUpdates();
            }, 1000);
            
            console.log('‚úÖ App hasieratuta - Supabase-k maneiatuko du auth');
        });
    </script>
</body>
</html>



























